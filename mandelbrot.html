<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="js/libs/jquery-1.10.2.js"></script>
  <script src="js/libs/underscore-1.5.1.js"></script>

  <script src="js/utils.js"></script>

</head>
<body>

<canvas id="canwass" width="640" height="640"></canvas>

<table id="tab">
  <tr><td id="plus">+</td>
      <td id="minus">-</td></tr>
</table>

<style>
 #tab    {width:654px;position: relative; right:7px;}
 #tab td {border:5px solid white;
          color:white;
          background-color:black;
          text-align:center;
          width:50%;
          cursor: pointer;
          font-weight: bold;
          font-size: 42px;
          } 
</style>


<script>

$(function () {

  brot = mkFractal('canwass',{
    fun      : isIn,
    paleta   : paleta,
    numIter  : 50, 
    deltaIter: 12,
    plusButt : 'plus',
    minusButt: 'minus'
  }).draw();

});

var paleta = function () {
  var p = [];

  p.push([  9,   1,  47]); // darkest blue
  p.push([  4,   4,  73]); // blue 5
  p.push([  0,   7, 100]); // blue 4
  p.push([ 12,  44, 138]); // blue 3
  p.push([ 24,  82, 177]); // blue 2
  p.push([ 57, 125, 209]); // blue 1
  p.push([134, 181, 229]); // blue 0
  p.push([211, 236, 248]); // lightest blue
  p.push([241, 233, 191]); // lightest yellow
  p.push([248, 201,  95]); // light yellow
  p.push([255, 170,   0]); // dirty yellow
  p.push([204, 128,   0]); // brown 0
  p.push([153,  87,   0]); // brown 1
  p.push([106,  52,   3]); // brown 2
  p.push([ 66,  30,  15]); // brown 3
  p.push([ 25,   7,  26]); // dark violett

  var len = p.length;
  return function (i) {
    if (i===-1) {return [0,0,0];}
    return p[i%len];
  }
}();


function isIn (xy,numIter) {
  var c = xy[0], d = xy[1];
  var a = c, b = d;
  var a2 = a*a, b2 = b*b;
  var i  = 0;
  var a_;
  while (i < numIter && a2+b2 <= 4) {
    a_ = a2-b2 + c;
    b  = 2*a*b + d;
    a  = a_;
    a2 = a*a; b2 = b*b; 
    i++;
  }
  return i == numIter ? {in:true} : {in:false, iter:i};
}



function mkFractal (canvasId, opts) {

  var fractalFun = opts.fun       || isIn;
  var numIter    = opts.numIter   || 50;
  var deltaIter  = opts.deltaIter || 0;

  var self, zoom, cX, cY, left, right, top, bottom, p, q;
  
  var el     = $('#'+canvasId);
  var canvas = el[0];
  var ctx    = canvas.getContext('2d');
  var xSize  = canvas.width;
  var ySize  = canvas.height;

  var imageData = ctx.getImageData(0, 0, xSize, ySize);
  var data = imageData.data;

  var paleta = opts.paleta;

  zoom = 0.5;
  setCenter([-0.3,0]);

  function move (e,max) {
    x_ = e.offsetX || e.pageX - $(e.target).position().left;
    y_ = e.offsetY || e.pageY - $(e.target).position().top;

    if (max) {
      draged = true;

      var dx = x_ - xSize/2;
      var dy = y_ - ySize/2;

      var delta = 5;
      var d = delta / Math.sqrt(dx*dx+dy*dy);
      
      dx = dx * d;
      dy = dy * d;
      
      setCenter(convert(xSize/2+dx,ySize/2+dy));
      draw();

    } else {
      setCenter(convert(x_,y_));
      draw();
    }
  }

  el.click(function(e){
    //move(e);
  });

  if (opts.plusButt) {
    $('#'+opts.plusButt).click(function(){zoomIt(true)});
  }
  if (opts.minusButt) {
    $('#'+opts.minusButt).click(function(){zoomIt(false)});
  }
  
  var mouseDown = false;
  var draged = false;

  el.mousedown(function(e){
    mouseDown = true;
  });
  el.mouseup(function(e){
    mouseDown = false;
    if (draged) {
      draged = false;
    } else {
      move(e);  
    }
  });


  el.mousemove(function(e){
    if (!mouseDown){return;}
    move(e,5);
  });
  

  //handles scrolling
  var mousewheelevt = 
    (/Firefox/i.test(navigator.userAgent)) ? 
      "DOMMouseScroll" : 
      "mousewheel"; //FF doesn't recognize mousewheel as of FF3.x
  el.bind(mousewheelevt, function(e){

    var evt = window.event || e //equalize event object
    //convert to originalEvent if possible                    
    evt = evt.originalEvent ? evt.originalEvent : evt; 
    //check for detail first, because it is used by Opera and FF
    var delta = evt.detail ? evt.detail*(-40) : evt.wheelDelta 

    zoomIt(delta > 0);
  });

  //prevents scrolling 
  el.on('DOMMouseScroll mousewheel', function(ev) {
    var $this = $(this),
        scrollTop = this.scrollTop,
        scrollHeight = this.scrollHeight,
        height = $this.height(),
        delta = (ev.type == 'DOMMouseScroll' ?
            ev.originalEvent.detail * -40 :
            ev.originalEvent.wheelDelta),
        up = delta > 0;

    var prevent = function() {
        ev.stopPropagation();
        ev.preventDefault();
        ev.returnValue = false;
        return false;
    }

    if (!up && -delta > scrollHeight - height - scrollTop) {
        // Scrolling down, but this will take us past the bottom.
        $this.scrollTop(scrollHeight);
        return prevent();
    } else if (up && delta > scrollTop) {
        // Scrolling up, but this will take us past the top.
        $this.scrollTop(0);
        return prevent();
    }
  });
  




  function init () {
    left   = cX - (1/zoom);
    right  = cX + (1/zoom);
    top    = cY + (1/zoom);
    bottom = cY - (1/zoom);
    p = (right-left)/(xSize-1); 
    q = (bottom-top)/(ySize-1);
    return self; 
  }

  function setCenter(pos) {
    cX = pos[0] || 0;
    cY = pos[1] || 0;
    return init();
  }

  function zoomIt (zoomIn) {
    zoom    *= ( zoomIn ? 2 : 0.5 ) ;
    numIter += ( zoomIn ? 1 :  -1 )*deltaIter ;
    numIter  = ( numIter >= 2 ? numIter : 2 );
    return init().draw();
  } 

  function convert(x,y) {
    return [x*p + left, y*q + top];
  }

  function getValue (x,y) {
    var res = fractalFun(convert(x,y),numIter);
    return res.in ? -1 : res.iter ;
    //Math.round(255*res.iter/(numIter) );
  }

  function draw() {
    var start = new Date().getTime();
    for (var y = 0; y < ySize; ++y) {
      for (var x = 0; x < xSize; ++x) {
        var v = getValue(x,y);

        var color = paleta(v);

        var index = (y * xSize + x) * 4;          
        data[index]   = color[0];  // red
        data[++index] = color[1];  // green
        data[++index] = color[2];  // blue
        data[++index] = 255;  // alpha
      }
    }
    ctx.putImageData(imageData, 0, 0);
    drawOther();
        
    var end = new Date().getTime();
    var time = end - start;
    ctx.font = "bold 12px sans-serif";
    ctx.fillStyle = "#413839";
    ctx.fillText(time+'ms', 2, 12);
    ctx.fillText(numIter+' iters',2,24);
    return self;
  }

  function drawOther () {
    drawLine('red',[xSize/2-3,ySize/2],[xSize/2+3,ySize/2]);
    drawLine('red',[xSize/2,ySize/2-3],[xSize/2,ySize/2+3]);
  }

  function drawLine (col,from,to) {
    ctx.strokeStyle = col;
    ctx.beginPath();
    ctx.moveTo(from[0],from[1]);
    ctx.lineTo(to[0],to[1]);
    ctx.stroke();    
  }

  self = {
    convert: convert,
    setCenter: setCenter,
    zoomIt: zoomIt,
    draw: draw
  }

  return self;
}





function randIxs(xSize,ySize, fun) {
  var xs = [];
  for (var y = 0; y < ySize; ++y) {
    for (var x = 0; x < xSize; ++x) {
      xs.push([x,y]);
    }
  } 

  xs = _.shuffle(xs);

  function run () {
    if (xs.length === 0){return;}
    var x = xs.pop();
    fun(x[0],x[1]);
    setTimeout(run,0);
  }
  run();
}


</script>

</body>
</html>
